<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Features [0]#Built on Spring Framework 5, Project Reactor and Spring Boot 2.0 Able to match routes on any request attribute. Predicates and filters are specific to routes. Circuit Breaker integration. Spring Cloud DiscoveryClient integration Easy to write Predicates and Filters Request Rate Limiting Path Rewriting 核心概念 [1][2]#路由（Route）
id：路由标识，要求唯一，名称任意（默认值 uuid，一般不用，需要自定义） uri：请求最终被转发到的目标地址 order： 路由优先级，数字越小，优先级越高 predicates：断言数组，即判断条件，如果返回值是boolean，则转发请求到 uri 属性指定的服务中 filters：过滤器数组，在请求传递过程中，对请求做一些修改 谓词、断言（Predicate） 允许开发人员匹配 HTTP 请求中的内容，比如请求头或请求参数，最后根据匹配结果返回一个布尔值。参照 Java8 的新特性Predicate.
过滤器（Filter） 可以在返回请求之前或之后修改请求和响应的内容。
路由（Route）[1][2]#服务发现-集成nacos服务注册中心 [2]#服务路由配置 spring: cloud: gateway: routes: - id: gateway-provider_1 ## 使用了lb形式，从注册中心负载均衡的获取uri uri: lb://gateway-provider ## 配置断言 predicates: - Path=/gateway/provider/** filters: - AddResponseHeader=X-Response-Foo, Bar 自动路由配置 # enabled：默认为false，设置为true表明spring cloud gateway开启服务发现和路由的功能，网关自动根据注册中心的服务名为每个服务创建一个router，将以服务名开头的请求路径转发到对应的服务 spring.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/">
  <meta property="og:site_name" content="Hugo Book">
  <meta property="og:title" content="API 网关-SpringCloud Gateway">
  <meta property="og:description" content="Features [0]#Built on Spring Framework 5, Project Reactor and Spring Boot 2.0 Able to match routes on any request attribute. Predicates and filters are specific to routes. Circuit Breaker integration. Spring Cloud DiscoveryClient integration Easy to write Predicates and Filters Request Rate Limiting Path Rewriting 核心概念 [1][2]#路由（Route）
id：路由标识，要求唯一，名称任意（默认值 uuid，一般不用，需要自定义） uri：请求最终被转发到的目标地址 order： 路由优先级，数字越小，优先级越高 predicates：断言数组，即判断条件，如果返回值是boolean，则转发请求到 uri 属性指定的服务中 filters：过滤器数组，在请求传递过程中，对请求做一些修改 谓词、断言（Predicate） 允许开发人员匹配 HTTP 请求中的内容，比如请求头或请求参数，最后根据匹配结果返回一个布尔值。参照 Java8 的新特性Predicate.
过滤器（Filter） 可以在返回请求之前或之后修改请求和响应的内容。
路由（Route）[1][2]#服务发现-集成nacos服务注册中心 [2]#服务路由配置 spring: cloud: gateway: routes: - id: gateway-provider_1 ## 使用了lb形式，从注册中心负载均衡的获取uri uri: lb://gateway-provider ## 配置断言 predicates: - Path=/gateway/provider/** filters: - AddResponseHeader=X-Response-Foo, Bar 自动路由配置 # enabled：默认为false，设置为true表明spring cloud gateway开启服务发现和路由的功能，网关自动根据注册中心的服务名为每个服务创建一个router，将以服务名开头的请求路径转发到对应的服务 spring.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2022-03-22T13:58:48+00:00">
    <meta property="article:modified_time" content="2022-03-22T13:58:48+00:00">
    <meta property="article:tag" content="API Gateway">
<title>API 网关-SpringCloud Gateway | Hugo Book</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/">
<link rel="stylesheet" href="/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.00f24245ba145350d6a7d4627a067b10704a773920b0be54d269e10ef5c946e1.js" integrity="sha256-APJCRboUU1DWp9RiegZ7EHBKdzkgsL5U0mnhDvXJRuE=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Hugo Book</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <span>服务治理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Overview</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Overview/microservice/" class="">微服务 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Overview/soaFeature/" class="">分布式服务框架功能</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>API Gateway</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/API-Gateway/apiGatawaySpringGateway/" class="active">API 网关-SpringCloud Gateway</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/API-Gateway/apiGatawayApisix/" class="">API 网关-apisix</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/API-Gateway/apiGateway/" class="">API Gateway网关</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Config &amp; Discovery</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/ConfigDiscovery/soaDiscovery/" class="">服务发现</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/ConfigDiscovery/config/" class="">服务治理-分布式配置</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>负载均衡</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/loadBalance/loadBalance/" class="">负载均衡-算法</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/loadBalance/nginxOptimize/" class="">Nginx优化</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/loadBalance/nginx/" class="">Nginx总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>线程模型</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/threadModel/jsfThreadModel/" class="">京东服务框架JSF服务提供者线程模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>容错&amp;限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>容错</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerateFramework/" class="">容错框架</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/faultTolerant/soaTimeout/" class="">超时和重试 总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/faultTolerant/soaTolerate/" class="">分布式服务框架 容错机制</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>限流</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/throttle/ratelimitSentinel/" class="">流量治理-Sentinel</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/throttle/ratelimit/" class="">限流-总结</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/soaGracefulStart/" class="">优雅启动</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/faultTolerant/soaGracefulClose/" class="">优雅关闭</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Spring Cloud</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Springcloud/springTransactionInvalid/" class="">Spring  Transaction  失效</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Springcloud/springCloud/" class="">SpringCloud</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Springcloud/springboot/" class="">SpringBoot</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Springcloud/springTransaction/" class="">Spring事务</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>灰度发布</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/Gray/apiGatewayGray/" class="">API 网关-灰度发布</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>安全</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/security/soaAuth/" class="">服务治理-鉴权</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/serviceGovernance/security/securityOAuth2/" class="">安全-OAuth2</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>API 网关-SpringCloud Gateway</h3>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#features-0">Features [0]</a></li>
    <li><a href="#核心概念-12">核心概念 [1][2]</a></li>
    <li><a href="#路由route12">路由（Route）[1][2]</a>
      <ul>
        <li>
          <ul>
            <li><a href="#服务发现-集成nacos服务注册中心-2">服务发现-集成nacos服务注册中心 [2]</a></li>
            <li><a href="#动态路由-整合-apollo-2">动态路由-整合 Apollo [2]</a></li>
            <li><a href="#动态路由-整合nacos--3">动态路由-整合nacos  [3]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#谓词断言predicate12">谓词、断言（Predicate）[1][2]</a></li>
    <li><a href="#过滤器filter12">过滤器（Filter）[1][2]</a></li>
    <li><a href="#稳定性">稳定性</a>
      <ul>
        <li>
          <ul>
            <li><a href="#熔断降级-hystrix-3">熔断降级-Hystrix [3]</a></li>
            <li><a href="#流控和降级-sentinel-3">流控和降级-Sentinel [3]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#高可用网关1">高可用网关[1]</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><p></p>
<!-- more -->
<h1 id="features-0">
  Features [0]
  <a class="anchor" href="#features-0">#</a>
</h1>
<ul>
<li>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</li>
<li>Able to match <strong>routes</strong> on any request attribute.</li>
<li><strong>Predicates and filters</strong> are specific to <strong>routes</strong>.</li>
<li><strong>Circuit Breaker</strong> integration.</li>
<li>Spring Cloud <strong>DiscoveryClient</strong> integration</li>
<li>Easy to write <strong>Predicates and Filters</strong></li>
<li>Request <strong>Rate Limiting</strong></li>
<li><strong>Path Rewriting</strong></li>
</ul>
<h1 id="核心概念-12">
  核心概念 [1][2]
  <a class="anchor" href="#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5-12">#</a>
</h1>
<ul>
<li>
<p>路由（Route）</p>
<ul>
<li>id：路由标识，要求唯一，名称任意（默认值 uuid，一般不用，需要自定义）</li>
<li>uri：请求最终被转发到的目标地址</li>
<li>order： 路由优先级，数字越小，优先级越高</li>
<li>predicates：断言数组，即判断条件，如果返回值是boolean，则转发请求到 uri 属性指定的服务中</li>
<li>filters：过滤器数组，在请求传递过程中，对请求做一些修改</li>
</ul>
</li>
<li>
<p>谓词、断言（Predicate）
允许开发人员匹配 HTTP 请求中的内容，比如请求头或请求参数，最后根据匹配结果返回一个<strong>布尔值</strong>。参照 Java8 的新特性Predicate.</p>
</li>
<li>
<p>过滤器（Filter）
可以在返回请求之前或之后<strong>修改请求和响应的内容</strong>。</p>
</li>
</ul>
<h1 id="路由route12">
  路由（Route）[1][2]
  <a class="anchor" href="#%e8%b7%af%e7%94%b1route12">#</a>
</h1>
<h3 id="服务发现-集成nacos服务注册中心-2">
  服务发现-集成nacos服务注册中心 [2]
  <a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0-%e9%9b%86%e6%88%90nacos%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83-2">#</a>
</h3>
<ul>
<li>服务路由配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">gateway-provider_1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">## 使用了lb形式，从注册中心负载均衡的获取uri</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://gateway-provider</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">## 配置断言</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/gateway/provider/**</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">AddResponseHeader=X-Response-Foo, Bar</span>
</span></span></code></pre></div><ul>
<li>自动路由配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># enabled：默认为false，设置为true表明spring cloud gateway开启服务发现和路由的功能，网关自动根据注册中心的服务名为每个服务创建一个router，将以服务名开头的请求路径转发到对应的服务</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spring.cloud.gateway.discovery.locator.enabled = true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># lowerCaseServiceId：启动 locator.enabled=true 自动路由时，路由的路径默认会使用大写ID，若想要使用小写ID，可将lowerCaseServiceId设置为true</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">spring.cloud.gateway.discovery.locator.lower-case-service-id = true</span>
</span></span></code></pre></div><h3 id="动态路由-整合-apollo-2">
  动态路由-整合 Apollo [2]
  <a class="anchor" href="#%e5%8a%a8%e6%80%81%e8%b7%af%e7%94%b1-%e6%95%b4%e5%90%88-apollo-2">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Apollo路由更改监听刷新
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GatewayPropertRefresher</span> <span style="color:#66d9ef">implements</span> ApplicationContextAware, ApplicationEventPublisherAware
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 监听路由修改
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApolloConfigChangeListener</span>(interestedKeyPrefixes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spring.cloud.gateway.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onChange</span>(ConfigChangeEvent changeEvent)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        refreshGatewayProperties(changeEvent);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 刷新路由信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refreshGatewayProperties</span>(ConfigChangeEvent changeEvent)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;gateway网关配置 刷新开始！&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        preDestroyGatewayProperties(changeEvent);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//更新配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">applicationContext</span>.<span style="color:#a6e22e">publishEvent</span>(<span style="color:#66d9ef">new</span> EnvironmentChangeEvent(changeEvent.<span style="color:#a6e22e">changedKeys</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//更新路由</span>
</span></span><span style="display:flex;"><span>        refreshGatewayRouteDefinition();
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;gateway网关配置 刷新完成！&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="动态路由-整合nacos--3">
  动态路由-整合nacos  [3]
  <a class="anchor" href="#%e5%8a%a8%e6%80%81%e8%b7%af%e7%94%b1-%e6%95%b4%e5%90%88nacos--3">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NacosDynamicRouteService</span> <span style="color:#66d9ef">implements</span> ApplicationEventPublisherAware {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String dataId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gateway-router&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String group <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DEFAULT_GROUP&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Value</span>(<span style="color:#e6db74">&#34;${spring.cloud.nacos.config.server-addr}&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String serverAddr;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> RouteDefinitionWriter routeDefinitionWriter;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> ApplicationEventPublisher applicationEventPublisher;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> ROUTE_LIST <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@PostConstruct</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dynamicRouteByNacosListener</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      ConfigService configService <span style="color:#f92672">=</span> NacosFactory.<span style="color:#a6e22e">createConfigService</span>(serverAddr);
</span></span><span style="display:flex;"><span>      configService.<span style="color:#a6e22e">getConfig</span>(dataId, group, 5000);
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      configService.<span style="color:#a6e22e">addListener</span>(dataId, group, <span style="color:#66d9ef">new</span> Listener() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">receiveConfigInfo</span>(String configInfo) {
</span></span><span style="display:flex;"><span>          clearRoute();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (StringUtil.<span style="color:#a6e22e">isNullOrEmpty</span>(configInfo)) {<span style="color:#75715e">//配置被删除</span>
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>RouteDefinition<span style="color:#f92672">&gt;</span> gatewayRouteDefinitions <span style="color:#f92672">=</span> JSONObject.<span style="color:#a6e22e">parseArray</span>(configInfo, RouteDefinition.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (RouteDefinition routeDefinition : gatewayRouteDefinitions) {
</span></span><span style="display:flex;"><span>              addRoute(routeDefinition);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            publish();
</span></span><span style="display:flex;"><span>          } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;receiveConfigInfo error&#34;</span> <span style="color:#f92672">+</span> e);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Executor <span style="color:#a6e22e">getExecutor</span>() {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (NacosException e) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;dynamicRouteByNacosListener error&#34;</span> <span style="color:#f92672">+</span> e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clearRoute</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (String id : ROUTE_LIST) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">routeDefinitionWriter</span>.<span style="color:#a6e22e">delete</span>(Mono.<span style="color:#a6e22e">just</span>(id)).<span style="color:#a6e22e">subscribe</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ROUTE_LIST.<span style="color:#a6e22e">clear</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addRoute</span>(RouteDefinition definition) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      routeDefinitionWriter.<span style="color:#a6e22e">save</span>(Mono.<span style="color:#a6e22e">just</span>(definition)).<span style="color:#a6e22e">subscribe</span>();
</span></span><span style="display:flex;"><span>      ROUTE_LIST.<span style="color:#a6e22e">add</span>(definition.<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span> log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;addRoute error&#34;</span> <span style="color:#f92672">+</span> e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h1 id="谓词断言predicate12">
  谓词、断言（Predicate）[1][2]
  <a class="anchor" href="#%e8%b0%93%e8%af%8d%e6%96%ad%e8%a8%80predicate12">#</a>
</h1>
<p>
  <img src="./images/Predicate.png" alt="Predicate" /></p>
<h1 id="过滤器filter12">
  过滤器（Filter）[1][2]
  <a class="anchor" href="#%e8%bf%87%e6%bb%a4%e5%99%a8filter12">#</a>
</h1>
<ul>
<li>
<p>生命周期</p>
<ul>
<li>PRE</li>
<li>POST</li>
</ul>
</li>
<li>
<p>作用范围</p>
<ul>
<li>GatewayFilter 局部过滤器
<ul>
<li>默认预定义
<ul>
<li><strong>限流</strong></li>
</ul>
</li>
</ul>
</li>
<li>GlobalFilter 全局过滤器
<ul>
<li>自定义全局过滤器
<ul>
<li><strong>统一鉴权过滤器</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="稳定性">
  稳定性
  <a class="anchor" href="#%e7%a8%b3%e5%ae%9a%e6%80%a7">#</a>
</h1>
<h3 id="熔断降级-hystrix-3">
  熔断降级-Hystrix [3]
  <a class="anchor" href="#%e7%86%94%e6%96%ad%e9%99%8d%e7%ba%a7-hystrix-3">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">server.port</span>: <span style="color:#ae81ff">8082</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gateway</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">password</span>: <span style="color:#ae81ff">123456</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">rateLimit_route</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">http://localhost:8000</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">order</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>:  <span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/test/**</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">filters</span>:   <span style="color:#75715e">##</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">StripPrefix=1</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Hystrix</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fallbackCmdA</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">fallbackUri</span>: <span style="color:#ae81ff">forward:/fallbackA</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hystrix.command.fallbackCmdA.execution.isolation.thread.timeoutInMilliseconds</span>: <span style="color:#ae81ff">5000</span>
</span></span></code></pre></div><h3 id="流控和降级-sentinel-3">
  流控和降级-Sentinel [3]
  <a class="anchor" href="#%e6%b5%81%e6%8e%a7%e5%92%8c%e9%99%8d%e7%ba%a7-sentinel-3">#</a>
</h3>
<h1 id="高可用网关1">
  高可用网关[1]
  <a class="anchor" href="#%e9%ab%98%e5%8f%af%e7%94%a8%e7%bd%91%e5%85%b31">#</a>
</h1>
<p>Nginx负载均衡到部署的多个Gateway</p>
<h1 id="参考">
  参考
  <a class="anchor" href="#%e5%8f%82%e8%80%83">#</a>
</h1>
<ol start="0">
<li>
<p>
  <a href="https://spring.io/projects/spring-cloud-gateway">spring-cloud-gateway</a></p>
</li>
<li>
<p>
  <a href="https://www.bilibili.com/video/BV11i4y1F7eu?p=8">2021最新(完整版)Gateway教学-第二代微服务网关组件SpringCloud-Gateway</a> *** V</p>
</li>
<li>
<p>
  <a href="https://blog.csdn.net/a745233700/article/details/122917167">Spring Cloud Gateway 服务网关的部署与使用详细介绍</a></p>
</li>
<li>
<p>
  <a href="https://www.cnblogs.com/crazymakercircle/p/11704077.html">SpringCloud gateway （史上最全）</a> 尼恩</p>
</li>
<li>
<p>
  <a href="https://www.cnblogs.com/crazymakercircle/p/17436191.html">3W字吃透：微服务网关SpringCloud gateway底层原理和实操</a>   尼恩 未</p>
</li>
</ol>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#features-0">Features [0]</a></li>
    <li><a href="#核心概念-12">核心概念 [1][2]</a></li>
    <li><a href="#路由route12">路由（Route）[1][2]</a>
      <ul>
        <li>
          <ul>
            <li><a href="#服务发现-集成nacos服务注册中心-2">服务发现-集成nacos服务注册中心 [2]</a></li>
            <li><a href="#动态路由-整合-apollo-2">动态路由-整合 Apollo [2]</a></li>
            <li><a href="#动态路由-整合nacos--3">动态路由-整合nacos  [3]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#谓词断言predicate12">谓词、断言（Predicate）[1][2]</a></li>
    <li><a href="#过滤器filter12">过滤器（Filter）[1][2]</a></li>
    <li><a href="#稳定性">稳定性</a>
      <ul>
        <li>
          <ul>
            <li><a href="#熔断降级-hystrix-3">熔断降级-Hystrix [3]</a></li>
            <li><a href="#流控和降级-sentinel-3">流控和降级-Sentinel [3]</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#高可用网关1">高可用网关[1]</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












